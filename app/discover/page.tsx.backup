'use client'

import { useState, useEffect, useCallback } from 'react'
import { useRouter } from 'next/navigation'
import { Search, MapPin, Star, Bell, X, SlidersHorizontal, List, Map as MapIcon, Navigation } from 'lucide-react'
import { useI18n } from '@/lib/i18n'
import { GoogleMap, useJsApiLoader, Marker, InfoWindow } from '@react-google-maps/api'

interface Venue {
  id: string
  name: string
  slug?: string
  district?: string
  city?: string
  rating?: number
  cuisine_type?: string
  price_level?: number
  type?: string
  lat?: number
  lon?: number
  address?: string
}

const SUPABASE_URL = 'https://ipobkbhcrkrqgbohdeea.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlwb2JrYmhjcmtycWdib2hkZWVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzE1MjgsImV4cCI6MjA4MDAwNzUyOH0.QaUkRsv_B3Msc9qYmE366k1x_sTe8j5GxLUO3oKKg3w'

const mapContainerStyle = {
  width: '100%',
  height: '100%'
}

const defaultCenter = {
  lat: 37.0344,  // Bodrum
  lng: 27.4305
}

const mapOptions = {
  disableDefaultUI: true,
  zoomControl: true,
  mapTypeControl: false,
  streetViewControl: false,
  styles: [
    { elementType: "geometry", stylers: [{ color: "#1a1a1a" }] },
    { elementType: "labels.text.stroke", stylers: [{ color: "#1a1a1a" }] },
    { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
    { featureType: "road", elementType: "geometry", stylers: [{ color: "#2a2a2a" }] },
    { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
    { featureType: "water", elementType: "geometry", stylers: [{ color: "#0e1626" }] },
    { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] },
    { featureType: "poi.business", stylers: [{ visibility: "off" }] },
  ]
}

export default function DiscoverPage() {
  const router = useRouter()
  const { t } = useI18n()
  const [venues, setVenues] = useState<Venue[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [searchTerm, setSearchTerm] = useState('')
  const [showFilters, setShowFilters] = useState(false)
  const [viewMode, setViewMode] = useState<'list' | 'map'>('list')
  const [selectedVenue, setSelectedVenue] = useState<Venue | null>(null)
  const [userLocation, setUserLocation] = useState<{lat: number, lng: number} | null>(null)
  
  // Filters
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null)
  const [selectedPriceRange, setSelectedPriceRange] = useState<number | null>(null)
  const [minRating, setMinRating] = useState<number | null>(null)
  const [selectedDistrict, setSelectedDistrict] = useState<string | null>(null)

  const { isLoaded } = useJsApiLoader({
    id: 'google-map-script',
    googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY || ''
  })

  const categories = [
    { id: 'restaurant', label: t.categories?.restaurant || 'Restoran', emoji: 'üçΩÔ∏è' },
    { id: 'cafe', label: t.categories?.cafe || 'Kafe', emoji: '‚òï' },
    { id: 'bar', label: t.categories?.bar || 'Bar', emoji: 'üç∏' },
    { id: 'beach_club', label: t.categories?.beachClub || 'Beach Club', emoji: 'üèñÔ∏è' },
    { id: 'fastfood', label: t.categories?.fastFood || 'Fast Food', emoji: 'üçî' },
    { id: 'nightclub', label: t.categories?.nightclub || 'Gece Kul√ºb√º', emoji: 'üéâ' },
  ]

  useEffect(() => {
    loadVenues()
    getUserLocation()
  }, [])

  const getUserLocation = () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setUserLocation({
            lat: position.coords.latitude,
            lng: position.coords.longitude
          })
        },
        () => console.log('Location permission denied')
      )
    }
  }

  const loadVenues = async () => {
    setLoading(true)
    setError(null)
    
    try {
      const response = await fetch(
        `${SUPABASE_URL}/rest/v1/venues?select=*&order=name.asc&limit=100`,
        {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
          }
        }
      )
      
      if (!response.ok) throw new Error('Failed to load venues')
      
      const data = await response.json()
      setVenues(data || [])
    } catch (err) {
      setError('Mekanlar y√ºklenirken hata olu≈ütu')
      console.error('Error loading venues:', err)
    } finally {
      setLoading(false)
    }
  }

  // Filtered venues
  const filteredVenues = venues.filter(v => {
    if (searchTerm && !v.name?.toLowerCase().includes(searchTerm.toLowerCase()) &&
        !v.district?.toLowerCase().includes(searchTerm.toLowerCase()) &&
        !v.cuisine_type?.toLowerCase().includes(searchTerm.toLowerCase())) {
      return false
    }
    if (selectedCategory && v.category !== selectedCategory) return false
    if (selectedPriceRange && v.price_level !== selectedPriceRange) return false
    if (minRating && (!v.rating || v.rating < minRating)) return false
    if (selectedDistrict && v.district !== selectedDistrict) return false
    return true
  })

  // Venues with coordinates for map
  const venuesWithCoords = filteredVenues.filter(v => v.lat && v.lon)

  const activeFilterCount = [selectedCategory, selectedPriceRange, minRating, selectedDistrict].filter(Boolean).length

  const clearFilters = () => {
    setSelectedCategory(null)
    setSelectedPriceRange(null)
    setMinRating(null)
    setSelectedDistrict(null)
  }

  const mapCenter = userLocation || (venuesWithCoords.length > 0 
    ? { lat: parseFloat(String(venuesWithCoords[0].lat)), lng: parseFloat(String(venuesWithCoords[0].lon)) }
    : defaultCenter)

  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white pb-24">
      {/* Header */}
      <div className="sticky top-0 z-40 bg-[#0a0a0a] border-b border-white/5 p-4">
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-2 text-gray-400 text-sm">
            <MapPin className="w-4 h-4 text-orange-500" />
            <span>{t.discover?.allVenues || 'T√ºm Mekanlar'}</span>
          </div>
          <div className="flex items-center gap-2">
            {/* View Mode Toggle */}
            <div className="flex bg-[#1a1a1a] rounded-lg p-1">
              <button
                onClick={() => setViewMode('list')}
                className={`p-2 rounded-md transition-colors ${viewMode === 'list' ? 'bg-orange-500 text-white' : 'text-gray-400'}`}
              >
                <List className="w-4 h-4" />
              </button>
              <button
                onClick={() => setViewMode('map')}
                className={`p-2 rounded-md transition-colors ${viewMode === 'map' ? 'bg-orange-500 text-white' : 'text-gray-400'}`}
              >
                <MapIcon className="w-4 h-4" />
              </button>
            </div>
            <button className="w-10 h-10 rounded-full bg-[#1a1a1a] flex items-center justify-center">
              <Bell className="w-5 h-5 text-gray-400" />
            </button>
          </div>
        </div>

        {/* Search Bar */}
        <div className="flex gap-2">
          <div className="flex-1 relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" />
            <input
              type="text"
              placeholder={t.discover?.searchPlaceholder || 'Mekan veya mutfak ara...'}
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-4 py-3 bg-[#1a1a1a] rounded-xl text-white placeholder-gray-500 outline-none border border-transparent focus:border-orange-500"
            />
            {searchTerm && (
              <button onClick={() => setSearchTerm('')} className="absolute right-3 top-1/2 -translate-y-1/2">
                <X className="w-4 h-4 text-gray-500" />
              </button>
            )}
          </div>
          <button
            onClick={() => setShowFilters(!showFilters)}
            className={`w-12 h-12 rounded-xl flex items-center justify-center relative ${showFilters || activeFilterCount > 0 ? 'bg-orange-500' : 'bg-[#1a1a1a]'}`}
          >
            <SlidersHorizontal className="w-5 h-5" />
            {activeFilterCount > 0 && (
              <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center">
                {activeFilterCount}
              </span>
            )}
          </button>
        </div>

        {/* Category Pills */}
        <div className="flex gap-2 mt-3 overflow-x-auto pb-1 -mx-4 px-4">
          {categories.map(cat => (
            <button
              key={cat.id}
              onClick={() => setSelectedCategory(selectedCategory === cat.id ? null : cat.id)}
              className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm whitespace-nowrap transition-colors ${
                selectedCategory === cat.id ? 'bg-orange-500 text-white' : 'bg-[#1a1a1a] text-gray-400'
              }`}
            >
              <span>{cat.emoji}</span>
              <span>{cat.label}</span>
            </button>
          ))}
        </div>
      </div>

      {/* Filters Panel */}
      {showFilters && (
        <div className="p-4 bg-[#111] border-b border-white/5 space-y-4">
          <div>
            <label className="text-sm text-gray-400 mb-2 block">{t.discover?.priceRange || 'Fiyat Aralƒ±ƒüƒ±'}</label>
            <div className="flex gap-2">
              {[1, 2, 3, 4].map(price => (
                <button
                  key={price}
                  onClick={() => setSelectedPriceRange(selectedPriceRange === price ? null : price)}
                  className={`flex-1 py-2 rounded-lg text-sm ${selectedPriceRange === price ? 'bg-orange-500' : 'bg-[#1a1a1a]'}`}
                >
                  {'‚Ç∫'.repeat(price)}
                </button>
              ))}
            </div>
          </div>
          <div>
            <label className="text-sm text-gray-400 mb-2 block">{t.discover?.minRating || 'Minimum Puan'}</label>
            <div className="flex gap-2">
              {[3, 3.5, 4, 4.5].map(rating => (
                <button
                  key={rating}
                  onClick={() => setMinRating(minRating === rating ? null : rating)}
                  className={`flex-1 py-2 rounded-lg text-sm flex items-center justify-center gap-1 ${minRating === rating ? 'bg-orange-500' : 'bg-[#1a1a1a]'}`}
                >
                  <Star className="w-3 h-3" /> {rating}+
                </button>
              ))}
            </div>
          </div>
          {activeFilterCount > 0 && (
            <button onClick={clearFilters} className="w-full py-2 text-orange-500 text-sm">
              {t.discover?.clearFilters || 'Filtreleri Temizle'}
            </button>
          )}
        </div>
      )}

      {/* Content */}
      {viewMode === 'list' ? (
        /* List View */
        <div className="p-4 space-y-3">
          {loading ? (
            <div className="space-y-3">
              {[1,2,3,4].map(i => (
                <div key={i} className="bg-[#1a1a1a] rounded-xl p-4 animate-pulse">
                  <div className="h-4 bg-gray-700 rounded w-3/4 mb-2" />
                  <div className="h-3 bg-gray-700 rounded w-1/2" />
                </div>
              ))}
            </div>
          ) : error ? (
            <div className="text-center py-10">
              <p className="text-red-500 mb-4">{error}</p>
              <button onClick={loadVenues} className="px-4 py-2 bg-orange-500 rounded-lg">
                {t.common?.retry || 'Tekrar Dene'}
              </button>
            </div>
          ) : filteredVenues.length === 0 ? (
            <div className="text-center py-10">
              <p className="text-gray-400">{t.discover?.noResults || 'Sonu√ß bulunamadƒ±'}</p>
            </div>
          ) : (
            filteredVenues.map(venue => (
              <button
                key={venue.id}
                onClick={() => router.push(`/venue/${venue.id}`)}
                className="w-full bg-[#1a1a1a] rounded-xl p-4 text-left hover:bg-[#222] transition-colors"
              >
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <h3 className="font-semibold">{venue.name}</h3>
                    <p className="text-sm text-gray-400 mt-1">
                      {venue.cuisine_type || venue.category} ‚Ä¢ {venue.district}
                    </p>
                    <div className="flex items-center gap-3 mt-2">
                      {venue.rating && (
                        <span className="flex items-center gap-1 text-sm">
                          <Star className="w-4 h-4 text-yellow-500 fill-yellow-500" />
                          {venue.rating}
                        </span>
                      )}
                      {venue.price_level && (
                        <span className="text-sm text-gray-500">
                          {'‚Ç∫'.repeat(venue.price_level)}
                        </span>
                      )}
                    </div>
                  </div>
                  <div className="w-16 h-16 bg-[#242424] rounded-lg flex items-center justify-center">
                    <span className="text-2xl">
                      {categories.find(c => c.id === venue.category)?.emoji || 'üçΩÔ∏è'}
                    </span>
                  </div>
                </div>
              </button>
            ))
          )}
        </div>
      ) : (
        /* Map View */
        <div className="h-[calc(100vh-250px)]">
          {isLoaded ? (
            <GoogleMap
              mapContainerStyle={mapContainerStyle}
              center={mapCenter}
              zoom={13}
              options={mapOptions}
            >
              {/* User Location Marker */}
              {userLocation && (
                <Marker
                  position={userLocation}
                  icon={{
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#3B82F6',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 3,
                  }}
                />
              )}

              {/* Venue Markers */}
              {venuesWithCoords.map(venue => (
                <Marker
                  key={venue.id}
                  position={{ lat: parseFloat(String(venue.lat)), lng: parseFloat(String(venue.lon)) }}
                  onClick={() => setSelectedVenue(venue)}
                  icon={{
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                      <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="18" fill="#f97316" stroke="#fff" stroke-width="3"/>
                        <text x="20" y="26" text-anchor="middle" font-size="16">${categories.find(c => c.id === venue.category)?.emoji || 'üçΩÔ∏è'}</text>
                      </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40),
                  }}
                />
              ))}

              {/* Info Window */}
              {selectedVenue && parseFloat(String(selectedVenue.lat)) && parseFloat(String(selectedVenue.lon)) && (
                <InfoWindow
                  position={{ lat: parseFloat(String(selectedVenue.lat)), lng: parseFloat(String(selectedVenue.lon)) }}
                  onCloseClick={() => setSelectedVenue(null)}
                >
                  <div className="p-2 min-w-[200px]">
                    <h3 className="font-bold text-gray-900">{selectedVenue.name}</h3>
                    <p className="text-sm text-gray-600 mt-1">{selectedVenue.district}</p>
                    {selectedVenue.rating && (
                      <div className="flex items-center gap-1 mt-1">
                        <Star className="w-4 h-4 text-yellow-500 fill-yellow-500" />
                        <span className="text-sm text-gray-700">{selectedVenue.rating}</span>
                      </div>
                    )}
                    <div className="flex gap-2 mt-3">
                      <button
                        onClick={() => router.push(`/venue/${selectedVenue.id}`)}
                        className="flex-1 py-2 bg-orange-500 text-white text-sm rounded-lg font-medium"
                      >
                        G√∂r√ºnt√ºle
                      </button>
                      <button
                        onClick={() => window.open(`https://www.google.com/maps/dir/?api=1&destination=${parseFloat(String(selectedVenue.lat))},${parseFloat(String(selectedVenue.lon))}`, '_blank')}
                        className="p-2 bg-blue-500 text-white rounded-lg"
                      >
                        <Navigation className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                </InfoWindow>
              )}
            </GoogleMap>
          ) : (
            <div className="h-full flex items-center justify-center bg-[#1a1a1a]">
              <div className="text-center">
                <div className="w-10 h-10 border-2 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto mb-4" />
                <p className="text-gray-400">Harita y√ºkleniyor...</p>
              </div>
            </div>
          )}
        </div>
      )}

      {/* Results Count */}
      {viewMode === 'list' && !loading && (
        <div className="px-4 py-2 text-center text-sm text-gray-500">
          {filteredVenues.length} {t.discover?.results || 'mekan bulundu'}
        </div>
      )}
    </div>
  )
}
