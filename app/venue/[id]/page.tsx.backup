'use client'

import { useState, useEffect } from 'react'
import { useParams, useRouter, useSearchParams } from 'next/navigation'
import { 
  ChevronLeft, Heart, Star, MapPin, Phone, Navigation,
  Share2, Calendar, ChevronDown, Plus, Minus, ShoppingCart,
  X, Wifi, CreditCard, Car, Dog, Music, Utensils, Clock,
  Instagram, Globe, Image as ImageIcon, Bell, Coffee, HelpCircle,
  AlertTriangle, Flame, Leaf, Receipt, Check
} from 'lucide-react'
import ShareModal from '@/components/ShareModal'
import { useAuth } from '@/lib/AuthContext'
import { supabase } from '@/lib/supabase'
import { useI18n } from '@/lib/i18n'
import { useCart } from '@/lib/CartContext'

const SUPABASE_URL = 'https://ipobkbhcrkrqgbohdeea.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlwb2JrYmhjcmtycWdib2hkZWVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzE1MjgsImV4cCI6MjA4MDAwNzUyOH0.QaUkRsv_B3Msc9qYmE366k1x_sTe8j5GxLUO3oKKg3w'

const fetchApi = async (endpoint: string) => {
  const response = await fetch(SUPABASE_URL + '/rest/v1/' + endpoint, {
    headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
  })
  if (!response.ok) throw new Error('HTTP ' + response.status)
  return response.json()
}

const postApi = async (table: string, data: any) => {
  const response = await fetch(SUPABASE_URL + '/rest/v1/' + table, {
    method: 'POST',
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal'
    },
    body: JSON.stringify(data)
  })
  if (!response.ok) throw new Error('HTTP ' + response.status)
  return true
}

interface Venue {
  id: string
  name: string
  slug: string
  description?: string
  address?: string
  district?: string
  city?: string
  phone?: string
  instagram?: string
  website?: string
  rating?: number
  review_count?: number
  features?: string[]
  images?: string[]
  latitude?: number
  longitude?: number
  cuisine_type?: string
  price_range?: number
}

interface MenuItem {
  id: string
  name: string
  description?: string
  price: number
  category_id: string
  image_url?: string
  allergens?: string[]
  is_popular?: boolean
  is_new?: boolean
  is_available?: boolean
  diet_tags?: string[]
  options?: MenuItemOption[]
  preparation_time?: number
}

interface MenuItemOption {
  id: string
  name: string
  choices: { id: string; name: string; price: number }[]
  required?: boolean
  max_select?: number
}

interface MenuCategory {
  id: string
  name: string
  items: MenuItem[]
}

interface CartItem {
  id: string
  name: string
  price: number
  quantity: number
  options?: { name: string; choice: string; price: number }[]
}

const allergenInfo: Record<string, { emoji: string; label: string }> = {
  gluten: { emoji: 'üåæ', label: 'Gluten' },
  dairy: { emoji: 'ü•õ', label: 'S√ºt' },
  eggs: { emoji: 'ü•ö', label: 'Yumurta' },
  nuts: { emoji: 'ü•ú', label: 'Kuruyemi≈ü' },
  peanuts: { emoji: 'ü•ú', label: 'Fƒ±stƒ±k' },
  soy: { emoji: 'ü´ò', label: 'Soya' },
  fish: { emoji: 'üêü', label: 'Balƒ±k' },
  shellfish: { emoji: 'ü¶ê', label: 'Kabuklu Deniz' },
  sesame: { emoji: 'üå∞', label: 'Susam' },
}

const dietInfo: Record<string, { emoji: string; label: string; color: string }> = {
  vegan: { emoji: 'üå±', label: 'Vegan', color: 'bg-green-500' },
  vegetarian: { emoji: 'ü•¨', label: 'Vejetaryen', color: 'bg-green-600' },
  gluten_free: { emoji: 'üåæ', label: 'Glutensiz', color: 'bg-amber-500' },
  halal: { emoji: '‚ò™Ô∏è', label: 'Helal', color: 'bg-emerald-500' },
}

export default function VenuePage() {
  const { t } = useI18n()
  const params = useParams()
  const router = useRouter()
  const searchParams = useSearchParams()
  const { user } = useAuth()
  const venueId = params.id as string
  const tableFromUrl = searchParams.get('table')
  const [orderMode, setOrderMode] = useState<string | null>(null)
  const canOrder = !!tableFromUrl || orderMode === 'takeaway'

  const [venue, setVenue] = useState<Venue | null>(null)
  const [categories, setCategories] = useState<MenuCategory[]>([])
  const [loading, setLoading] = useState(true)
  const [activeTab, setActiveTab] = useState('about')
  const [expandedCategory, setExpandedCategory] = useState<string | null>(null)
  const { items: cart, addItem, cartCount, totalPrice: cartTotal } = useCart()
  const [showCart, setShowCart] = useState(false)
  const [showShareModal, setShowShareModal] = useState(false)
  const [showReservationModal, setShowReservationModal] = useState(false)
  const [showWaiterCallModal, setShowWaiterCallModal] = useState(false)
  const [isFavorite, setIsFavorite] = useState(false)
  const [favoriteId, setFavoriteId] = useState<string | null>(null)
  const [favoriteLoading, setFavoriteLoading] = useState(false)
  const [selectedItem, setSelectedItem] = useState<MenuItem | null>(null)
  const [showItemModal, setShowItemModal] = useState(false)
  const [selectedOptions, setSelectedOptions] = useState<Record<string, { choice: string; price: number }>>({})
  const [dietFilter, setDietFilter] = useState<string | null>(null)
  const [showBillPreview, setShowBillPreview] = useState(false)

  const featureLabels: Record<string, { icon: any; label: string }> = {
    wifi: { icon: Wifi, label: t.venue?.wifi || 'Wi-Fi' },
    card_payment: { icon: CreditCard, label: t.venue?.cardPayment || 'Kart' },
    parking: { icon: Car, label: t.venue?.parking || 'Otopark' },
    pet_friendly: { icon: Dog, label: t.venue?.petFriendly || 'Evcil Hayvan' },
    live_music: { icon: Music, label: t.venue?.liveMusic || 'Canlƒ± M√ºzik' },
    breakfast: { icon: Utensils, label: t.venue?.breakfast || 'Kahvaltƒ±' },
    outdoor: { icon: Utensils, label: t.venue?.outdoor || 'A√ßƒ±k Alan' },
    reservation: { icon: Calendar, label: t.venue?.reservation || 'Rezervasyon' },
  }

  useEffect(() => {
    loadVenue()
  }, [venueId])

  useEffect(() => {
    const mode = localStorage.getItem('order_mode')
    setOrderMode(mode)
  }, [])

  useEffect(() => {
    if (user && venue) checkFavorite()
  }, [user, venue])

  const loadVenue = async () => {
    try {
      const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(venueId)
      const endpoint = isUUID ? `venues?id=eq.${venueId}` : `venues?slug=eq.${venueId}`
      const data = await fetchApi(endpoint)
      if (data && data.length > 0) {
        setVenue(data[0])
        loadMenu(data[0].id)
      }
    } catch (error) {
      console.error('Error loading venue:', error)
    }
    setLoading(false)
  }

  const loadMenu = async (vid: string) => {
    try {
      const [cats, items] = await Promise.all([
        fetchApi(`menu_categories?venue_id=eq.${vid}&order=sort_order`),
        fetchApi(`menu_items?venue_id=eq.${vid}`)
      ])
      const categoriesWithItems = (cats || []).map((cat: any) => ({
        ...cat,
        items: (items || []).filter((item: any) => item.category_id === cat.id)
      })).filter((cat: any) => cat.items.length > 0)
      setCategories(categoriesWithItems)
      if (categoriesWithItems.length > 0) setExpandedCategory(categoriesWithItems[0].id)
    } catch (error) {
      console.error('Error loading menu:', error)
    }
  }

  const checkFavorite = async () => {
    if (!user || !venue) return
    try {
      const { data, error } = await supabase
        .from('favorites')
        .select('id')
        .eq('user_id', user.id)
        .eq('venue_id', venue.id)
        .maybeSingle()
      
      if (error) {
        console.error('Check favorite error:', error)
        return
      }
      
      if (data) {
        setIsFavorite(true)
        setFavoriteId(data.id)
      }
    } catch (err) {
      console.error('Check favorite exception:', err)
    }
  }

  const toggleFavorite = async () => {
    if (!venue) {
      console.log('No venue to favorite')
      return
    }
    
    if (!user) {
      console.log('User not logged in, redirecting to auth')
      router.push('/auth')
      return
    }

    setFavoriteLoading(true)
    console.log('Toggling favorite for venue:', venue.id, 'user:', user.id)

    try {
      if (isFavorite && favoriteId) {
        // Remove favorite
        const { error } = await supabase
          .from('favorites')
          .delete()
          .eq('id', favoriteId)
        
        if (error) {
          console.error('Remove favorite error:', error)
          alert('Favoriden √ßƒ±karƒ±lƒ±rken hata olu≈ütu')
        } else {
          console.log('Favorite removed successfully')
          setIsFavorite(false)
          setFavoriteId(null)
        }
      } else {
        // Add favorite
        const { data, error } = await supabase
          .from('favorites')
          .insert({ 
            user_id: user.id, 
            venue_id: venue.id 
          })
          .select('id')
          .single()
        
        if (error) {
          console.error('Add favorite error:', error)
          alert('Favorilere eklenirken hata olu≈ütu: ' + error.message)
        } else if (data) {
          console.log('Favorite added successfully:', data.id)
          setIsFavorite(true)
          setFavoriteId(data.id)
        }
      }
    } catch (err) {
      console.error('Toggle favorite exception:', err)
      alert('Bir hata olu≈ütu')
    } finally {
      setFavoriteLoading(false)
    }
  }

  const addToCart = (item: MenuItem, options?: Record<string, { choice: string; price: number }>) => {
    const optionsArray = options ? Object.entries(options).map(([name, opt]) => ({
      name,
      choice: opt.choice,
      price: opt.price
    })) : []
    const optionsPrice = optionsArray.reduce((sum, opt) => sum + opt.price, 0)
    const totalPrice = item.price + optionsPrice
    const cartId = options ? `${item.id}-${JSON.stringify(options)}` : item.id

    addItem({
      id: cartId,
      name: item.name,
      price: totalPrice,
      quantity: 1,
      options: optionsArray.length > 0 ? optionsArray : undefined
    }, venue?.id || '', venue?.name || '')
  }

  const openItemModal = (item: MenuItem) => {
    if (item.is_available === false) return
    if (item.options && item.options.length > 0) {
      setSelectedItem(item)
      setSelectedOptions({})
      setShowItemModal(true)
    } else {
      addToCart(item)
    }
  }

  const handleAddWithOptions = () => {
    if (!selectedItem) return
    addToCart(selectedItem, selectedOptions)
    setShowItemModal(false)
    setSelectedItem(null)
    setSelectedOptions({})
  }

  const filterItemsByDiet = (items: MenuItem[]) => {
    if (!dietFilter) return items
    return items.filter(item => item.diet_tags?.includes(dietFilter))
  }

  const openDirections = () => {
    if (venue?.latitude && venue?.longitude) {
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${venue.latitude},${venue.longitude}`, '_blank')
    } else if (venue?.address) {
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(venue.address + ', ' + venue.district + ', ' + venue.city)}`, '_blank')
    }
  }


  if (loading) {
    return (
      <div className="min-h-screen bg-[#0a0a0a] flex items-center justify-center">
        <div className="w-10 h-10 border-2 border-orange-500 border-t-transparent rounded-full animate-spin" />
      </div>
    )
  }

  if (!venue) {
    return (
      <div className="min-h-screen bg-[#0a0a0a] text-white flex flex-col items-center justify-center p-4">
        <p className="text-gray-400 mb-4">{t.venue?.notFound || 'Mekan bulunamadƒ±'}</p>
        <button onClick={() => router.back()} className="px-4 py-2 bg-orange-500 rounded-lg">{t.venue?.goBack || 'Geri D√∂n'}</button>
      </div>
    )
  }

  const venueImages = venue.images && venue.images.length > 0 ? venue.images : [
    'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400',
    'https://images.unsplash.com/photo-1552566626-52f8b828add9?w=400',
    'https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=400'
  ]

  const venueFeatures = venue.features && venue.features.length > 0 ? venue.features : ['wifi', 'card_payment', 'parking', 'pet_friendly']

  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white pb-32">
      {/* Header */}
      <div className="sticky top-0 z-40 bg-[#0a0a0a]/95 backdrop-blur border-b border-white/5">
        <div className="flex items-center justify-between p-4">
          <button onClick={() => router.back()} className="w-10 h-10 rounded-full bg-[#1a1a1a] flex items-center justify-center">
            <ChevronLeft className="w-5 h-5" />
          </button>
          <div className="flex gap-2">
            <button 
              onClick={toggleFavorite} 
              disabled={favoriteLoading}
              className="w-10 h-10 rounded-full bg-[#1a1a1a] flex items-center justify-center disabled:opacity-50"
            >
              <Heart className={`w-5 h-5 transition-colors ${isFavorite ? 'fill-red-500 text-red-500' : ''}`} />
            </button>
            <button onClick={() => setShowShareModal(true)} className="w-10 h-10 rounded-full bg-[#1a1a1a] flex items-center justify-center">
              <Share2 className="w-5 h-5" />
            </button>
          </div>
        </div>
      </div>

      <div className="p-4">
        {/* Venue Header */}
        <h1 className="text-2xl font-bold mb-2">{venue.name}</h1>
        
        <div className="flex items-center gap-3 text-sm text-gray-400 mb-2">
          {venue.rating && (
            <div className="flex items-center gap-1 text-green-500">
              <Star className="w-4 h-4 fill-green-500" />
              <span className="font-medium">{venue.rating}</span>
              {venue.review_count && <span className="text-gray-500">({venue.review_count})</span>}
            </div>
          )}
          {venue.cuisine_type && <span className="text-orange-500">{venue.cuisine_type}</span>}
          {venue.price_range && <span>{'‚Ç∫'.repeat(venue.price_range)}</span>}
        </div>

        <div className="flex items-center gap-2 text-sm text-gray-400 mb-4">
          <MapPin className="w-4 h-4 flex-shrink-0" />
          <span>{venue.district}, {venue.city}</span>
        </div>

        {/* Action Buttons */}
        <div className="flex gap-2 mb-4">
          <button onClick={() => setShowReservationModal(true)} className="flex-1 py-3 bg-orange-500 rounded-xl font-semibold flex items-center justify-center gap-2">
            <Calendar className="w-5 h-5" />
            {t.venue?.reserve || 'Rezervasyon'}
          </button>
          <button onClick={openDirections} className="w-12 h-12 bg-[#1a1a1a] rounded-xl flex items-center justify-center">
            <Navigation className="w-5 h-5 text-blue-500" />
          </button>
          {venue.phone && (
            <a href={`tel:${venue.phone}`} className="w-12 h-12 bg-[#1a1a1a] rounded-xl flex items-center justify-center">
              <Phone className="w-5 h-5 text-green-500" />
            </a>
          )}
        </div>

        {/* Waiter Call Button */}
        {canOrder && (
          <button onClick={() => setShowWaiterCallModal(true)} className="w-full py-3 mb-4 bg-purple-600 rounded-xl font-semibold flex items-center justify-center gap-2">
            <Bell className="w-5 h-5" />
            {t.venue?.callWaiter || 'Garson √áaƒüƒ±r'}
          </button>
        )}

        {/* Tabs */}
        <div className="flex gap-4 border-b border-white/10 mb-4">
          <button onClick={() => setActiveTab('about')} className={`pb-3 text-sm font-medium ${activeTab === 'about' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400'}`}>
            {t.venue?.about || 'Hakkƒ±nda'}
          </button>
          <button onClick={() => setActiveTab('menu')} className={`pb-3 text-sm font-medium ${activeTab === 'menu' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400'}`}>
            {t.venue?.menu || 'Men√º'}
          </button>
          <button onClick={() => setActiveTab('reviews')} className={`pb-3 text-sm font-medium ${activeTab === 'reviews' ? 'text-orange-500 border-b-2 border-orange-500' : 'text-gray-400'}`}>
            {t.venue?.reviews || 'Yorumlar'}
          </button>
        </div>

        {/* About Tab */}
        {activeTab === 'about' && (
          <div className="space-y-6">
            {venue.description && <p className="text-gray-300 leading-relaxed">{venue.description}</p>}

            {/* Images Gallery */}
            <div>
              <h3 className="font-semibold mb-3 flex items-center gap-2">
                <ImageIcon className="w-5 h-5 text-orange-500" />
                {t.venue?.photos || 'Fotoƒüraflar'}
              </h3>
              <div className="flex gap-2 overflow-x-auto pb-2 -mx-4 px-4">
                {venueImages.map((img, idx) => (
                  <div key={idx} className="flex-shrink-0 w-40 h-28 rounded-xl overflow-hidden bg-[#1a1a1a]">
                    <img src={img} alt="" className="w-full h-full object-cover" />
                  </div>
                ))}
              </div>
            </div>

            {/* Features */}
            <div>
              <h3 className="font-semibold mb-3">{t.venue?.businessFeatures || '√ñzellikler'}</h3>
              <div className="flex flex-wrap gap-2">
                {venueFeatures.map(feature => {
                  const info = featureLabels[feature]
                  if (!info) return null
                  const Icon = info.icon
                  return (
                    <span key={feature} className="flex items-center gap-2 px-3 py-2 bg-[#1a1a1a] rounded-xl text-sm">
                      <Icon className="w-4 h-4 text-orange-500" />
                      {info.label}
                    </span>
                  )
                })}
              </div>
            </div>

            {/* Address & Contact */}
            <div>
              <h3 className="font-semibold mb-3">{t.venue?.addressAndContact || 'Adres ve ƒ∞leti≈üim'}</h3>
              <div className="bg-[#1a1a1a] rounded-xl p-4 space-y-3">
                {venue.address && (
                  <button onClick={openDirections} className="flex items-start gap-3 w-full text-left">
                    <MapPin className="w-5 h-5 text-orange-500 mt-0.5 flex-shrink-0" />
                    <div>
                      <p className="text-gray-300">{venue.address}</p>
                      <p className="text-gray-500 text-sm">{venue.district}, {venue.city}</p>
                      <p className="text-blue-500 text-sm mt-1">{t.venue?.getDirections || 'Yol tarifi al'}</p>
                    </div>
                  </button>
                )}
                {venue.phone && (
                  <a href={`tel:${venue.phone}`} className="flex items-center gap-3">
                    <Phone className="w-5 h-5 text-green-500" />
                    <span className="text-gray-300">{venue.phone}</span>
                  </a>
                )}
                {venue.instagram && (
                  <a href={`https://instagram.com/${venue.instagram}`} target="_blank" className="flex items-center gap-3">
                    <Instagram className="w-5 h-5 text-pink-500" />
                    <span className="text-gray-300">@{venue.instagram}</span>
                  </a>
                )}
                {venue.website && (
                  <a href={venue.website} target="_blank" className="flex items-center gap-3">
                    <Globe className="w-5 h-5 text-blue-500" />
                    <span className="text-gray-300">{venue.website}</span>
                  </a>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Menu Tab */}
        {activeTab === 'menu' && (
          <div className="space-y-4">
            {/* Diet Filters */}
            <div className="flex gap-2 overflow-x-auto pb-2 -mx-4 px-4 scrollbar-hide">
              <button
                onClick={() => setDietFilter(null)}
                className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${
                  !dietFilter ? 'bg-orange-500 text-white' : 'bg-[#1a1a1a] text-gray-400'
                }`}
              >
                {t.menu?.all || 'T√ºm√º'}
              </button>
              {Object.entries(dietInfo).map(([key, info]) => (
                <button
                  key={key}
                  onClick={() => setDietFilter(dietFilter === key ? null : key)}
                  className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap flex items-center gap-1 transition-colors ${
                    dietFilter === key ? `${info.color} text-white` : 'bg-[#1a1a1a] text-gray-400'
                  }`}
                >
                  <span>{info.emoji}</span>
                  <span>{info.label}</span>
                </button>
              ))}
            </div>

            {categories.length === 0 ? (
              <p className="text-gray-400 text-center py-8">{t.venue?.menuNotFound || 'Men√º bulunamadƒ±'}</p>
            ) : (
              categories.map(category => {
                const filteredItems = filterItemsByDiet(category.items)
                if (filteredItems.length === 0) return null
                return (
                  <div key={category.id} className="bg-[#1a1a1a] rounded-xl overflow-hidden">
                    <button onClick={() => setExpandedCategory(expandedCategory === category.id ? null : category.id)} className="w-full flex items-center justify-between p-4">
                      <span className="font-semibold">{category.name}</span>
                      <div className="flex items-center gap-2">
                        <span className="text-xs text-gray-500">{filteredItems.length} {t.menu?.items || '√ºr√ºn'}</span>
                        <ChevronDown className={`w-5 h-5 transition-transform ${expandedCategory === category.id ? 'rotate-180' : ''}`} />
                      </div>
                    </button>
                    {expandedCategory === category.id && (
                      <div className="border-t border-white/5">
                        {filteredItems.map(item => {
                          const isOutOfStock = item.is_available === false
                          return (
                            <div 
                              key={item.id} 
                              className={`p-4 border-b border-white/5 last:border-0 ${isOutOfStock ? 'opacity-50' : ''}`}
                            >
                              <div className="flex gap-3">
                                <div className="relative w-20 h-20 rounded-lg overflow-hidden flex-shrink-0 bg-[#242424]">
                                  {item.image_url ? (
                                    <img src={item.image_url} alt={item.name} className="w-full h-full object-cover" />
                                  ) : (
                                    <div className="w-full h-full flex items-center justify-center">
                                      <Utensils className="w-8 h-8 text-gray-600" />
                                    </div>
                                  )}
                                  {isOutOfStock && (
                                    <div className="absolute inset-0 bg-black/70 flex items-center justify-center">
                                      <span className="text-xs font-bold text-red-500">{t.menu?.outOfStock || 'T√ºkendi'}</span>
                                    </div>
                                  )}
                                  {item.is_popular && !isOutOfStock && (
                                    <div className="absolute top-1 left-1 px-1.5 py-0.5 bg-orange-500 rounded text-[10px] font-bold flex items-center gap-0.5">
                                      <Flame className="w-2.5 h-2.5" />
                                      {t.menu?.popular || 'Pop√ºler'}
                                    </div>
                                  )}
                                  {item.is_new && !item.is_popular && !isOutOfStock && (
                                    <div className="absolute top-1 left-1 px-1.5 py-0.5 bg-blue-500 rounded text-[10px] font-bold">
                                      {t.menu?.new || 'Yeni'}
                                    </div>
                                  )}
                                </div>

                                <div className="flex-1 min-w-0">
                                  <div className="flex justify-between items-start gap-2">
                                    <div className="flex-1 min-w-0">
                                      <div className="flex items-center gap-2 flex-wrap">
                                        <h4 className="font-medium">{item.name}</h4>
                                        {item.diet_tags?.map(tag => (
                                          <span key={tag} className="text-xs" title={dietInfo[tag]?.label}>
                                            {dietInfo[tag]?.emoji}
                                          </span>
                                        ))}
                                      </div>
                                      
                                      {item.description && (
                                        <p className="text-sm text-gray-400 mt-1 line-clamp-2">{item.description}</p>
                                      )}
                                      
                                      {item.allergens && item.allergens.length > 0 && (
                                        <div className="flex items-center gap-1 mt-2">
                                          <AlertTriangle className="w-3 h-3 text-yellow-500" />
                                          <span className="text-xs text-yellow-500">
                                            {item.allergens.map(a => allergenInfo[a]?.emoji || a).join(' ')}
                                          </span>
                                        </div>
                                      )}
                                      
                                      <div className="flex items-center gap-3 mt-2">
                                        <p className="text-orange-500 font-semibold">‚Ç∫{item.price}</p>
                                        {item.preparation_time && (
                                          <span className="text-xs text-gray-500 flex items-center gap-1">
                                            <Clock className="w-3 h-3" />
                                            ~{item.preparation_time} {t.menu?.minutes || 'dk'}
                                          </span>
                                        )}
                                        {item.options && item.options.length > 0 && (
                                          <span className="text-xs text-purple-400">{t.menu?.hasOptions || 'Se√ßenekli'}</span>
                                        )}
                                      </div>
                                    </div>
                                    
                                    {canOrder && (
                                      <button 
                                        onClick={() => openItemModal(item)} 
                                        disabled={isOutOfStock}
                                        className={`w-9 h-9 rounded-lg flex items-center justify-center flex-shrink-0 transition-colors ${
                                          isOutOfStock 
                                            ? 'bg-gray-700 cursor-not-allowed' 
                                            : 'bg-orange-500 hover:bg-orange-600'
                                        }`}
                                      >
                                        <Plus className="w-5 h-5" />
                                      </button>
                                    )}
                                  </div>
                                </div>
                              </div>
                            </div>
                          )
                        })}
                      </div>
                    )}
                  </div>
                )
              })
            )}
          </div>
        )}

        {/* Reviews Tab */}
        {activeTab === 'reviews' && (
          <div className="space-y-4">
            <div className="bg-[#1a1a1a] rounded-xl p-4 text-center">
              <div className="flex items-center justify-center gap-2 mb-2">
                <Star className="w-8 h-8 text-yellow-500 fill-yellow-500" />
                <span className="text-3xl font-bold">{venue.rating || '-'}</span>
              </div>
              <p className="text-gray-400 text-sm">{venue.review_count || 0} {t.venue?.reviewsCount || 'deƒüerlendirme'}</p>
            </div>
          </div>
        )}
      </div>

      {/* Cart Button */}
      {cartCount > 0 && (
        <div className="fixed bottom-20 left-4 right-4">
          <button onClick={() => router.push('/cart')} className="w-full py-4 bg-orange-500 rounded-xl font-semibold flex items-center justify-between px-4">
            <span className="flex items-center gap-2"><ShoppingCart className="w-5 h-5" />{cartCount} {t.venue?.items || '√ºr√ºn'}</span>
            <span>‚Ç∫{cartTotal.toFixed(2)}</span>
          </button>
        </div>
      )}

      {/* Modals */}
      {showReservationModal && <ReservationModal venue={venue} onClose={() => setShowReservationModal(false)} />}
      {showShareModal && <ShareModal venue={venue} onClose={() => setShowShareModal(false)} />}
      {showWaiterCallModal && <WaiterCallModal venue={venue} tableNumber={tableFromUrl || ''} onClose={() => setShowWaiterCallModal(false)} />}
      
      {/* Item Customization Modal */}
      {showItemModal && selectedItem && (
        <div className="fixed inset-0 z-50 bg-black/80 flex items-end">
          <div className="w-full bg-[#1a1a1a] rounded-t-3xl max-h-[85vh] overflow-hidden flex flex-col">
            <div className="p-4 border-b border-white/10 flex items-center justify-between flex-shrink-0">
              <h2 className="text-lg font-bold">{selectedItem.name}</h2>
              <button onClick={() => setShowItemModal(false)} className="p-2 hover:bg-white/10 rounded-full">
                <X className="w-5 h-5" />
              </button>
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-4">
              <div className="flex gap-4">
                {selectedItem.image_url && (
                  <div className="w-24 h-24 rounded-xl overflow-hidden flex-shrink-0">
                    <img src={selectedItem.image_url} alt={selectedItem.name} className="w-full h-full object-cover" />
                  </div>
                )}
                <div className="flex-1">
                  {selectedItem.description && (
                    <p className="text-gray-400 text-sm">{selectedItem.description}</p>
                  )}
                  {selectedItem.allergens && selectedItem.allergens.length > 0 && (
                    <div className="flex items-center gap-2 mt-2 p-2 bg-yellow-500/10 rounded-lg">
                      <AlertTriangle className="w-4 h-4 text-yellow-500" />
                      <span className="text-xs text-yellow-500">
                        {t.menu?.allergens || 'Alerjenler'}: {selectedItem.allergens.map(a => allergenInfo[a]?.label || a).join(', ')}
                      </span>
                    </div>
                  )}
                </div>
              </div>

              {selectedItem.options?.map(option => (
                <div key={option.id} className="bg-[#242424] rounded-xl p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="font-semibold">{option.name}</h3>
                    {option.required && (
                      <span className="text-xs px-2 py-1 bg-orange-500/20 text-orange-500 rounded-full">
                        {t.menu?.required || 'Zorunlu'}
                      </span>
                    )}
                  </div>
                  <div className="space-y-2">
                    {option.choices.map(choice => {
                      const isSelected = selectedOptions[option.name]?.choice === choice.name
                      return (
                        <button
                          key={choice.id}
                          onClick={() => setSelectedOptions(prev => ({
                            ...prev,
                            [option.name]: { choice: choice.name, price: choice.price }
                          }))}
                          className={`w-full p-3 rounded-xl flex items-center justify-between transition-colors ${
                            isSelected 
                              ? 'bg-orange-500/20 border-2 border-orange-500' 
                              : 'bg-[#1a1a1a] border-2 border-transparent'
                          }`}
                        >
                          <div className="flex items-center gap-3">
                            <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${
                              isSelected ? 'border-orange-500 bg-orange-500' : 'border-gray-500'
                            }`}>
                              {isSelected && <Check className="w-3 h-3 text-white" />}
                            </div>
                            <span>{choice.name}</span>
                          </div>
                          {choice.price > 0 && (
                            <span className="text-orange-500 text-sm">+‚Ç∫{choice.price}</span>
                          )}
                        </button>
                      )
                    })}
                  </div>
                </div>
              ))}
            </div>

            <div className="p-4 border-t border-white/10 flex-shrink-0">
              <div className="flex items-center justify-between mb-3">
                <span className="text-gray-400">{t.cart?.total || 'Toplam'}</span>
                <span className="text-xl font-bold text-orange-500">
                  ‚Ç∫{selectedItem.price + Object.values(selectedOptions).reduce((sum, opt) => sum + opt.price, 0)}
                </span>
              </div>
              <button
                onClick={handleAddWithOptions}
                className="w-full py-4 bg-orange-500 hover:bg-orange-600 rounded-xl font-bold flex items-center justify-center gap-2"
              >
                <Plus className="w-5 h-5" />
                {t.menu?.addToCart || 'Sepete Ekle'}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

function ReservationModal({ venue, onClose }: { venue: Venue; onClose: () => void }) {
  const { t } = useI18n()
  const { user, profile } = useAuth()
  const [date, setDate] = useState(new Date().toISOString().split('T')[0])
  const [time, setTime] = useState('19:00')
  const [guests, setGuests] = useState('2')
  const [name, setName] = useState(profile?.display_name || '')
  const [notes, setNotes] = useState('')
  const [loading, setLoading] = useState(false)
  const [success, setSuccess] = useState(false)

  const handleSubmit = async () => {
    if (!date || !time || !name) { alert(t.reservations?.fillRequired || 'L√ºtfen zorunlu alanlarƒ± doldurun'); return }
    setLoading(true)
    try {
      await postApi('reservations', {
        venue_id: venue.id,
        user_id: user?.id || null,
        customer_name: name,
        reservation_date: date,
        reservation_time: time,
        party_size: parseInt(guests),
        notes: notes || null,
        status: 'pending'
      })
      setSuccess(true)
    } catch (error) {
      console.error('Reservation error:', error)
      alert(t.reservations?.createError || 'Rezervasyon olu≈üturulurken hata olu≈ütu')
    }
    setLoading(false)
  }

  if (success) {
    return (
      <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div className="w-full max-w-sm bg-[#1a1a1a] rounded-2xl p-6 text-center">
          <div className="w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto mb-4">
            <Calendar className="w-8 h-8 text-green-500" />
          </div>
          <h2 className="text-xl font-bold mb-2">{t.reservations?.received || 'Rezervasyon Alƒ±ndƒ±!'}</h2>
          <p className="text-gray-400 mb-4">{venue.name}</p>
          <p className="text-sm text-gray-400 mb-6">{date} - {time} - {guests} {t.reservations?.person || 'ki≈üi'}</p>
          <button onClick={onClose} className="w-full py-3 bg-orange-500 rounded-xl font-semibold">{t.reservations?.ok || 'Tamam'}</button>
        </div>
      </div>
    )
  }

  return (
    <div className="fixed inset-0 z-50 bg-black/80 flex items-end justify-center">
      <div className="w-full max-w-lg bg-[#1a1a1a] rounded-t-3xl max-h-[90vh] overflow-y-auto">
        <div className="sticky top-0 bg-[#1a1a1a] p-4 border-b border-white/10 flex items-center justify-between">
          <h2 className="text-xl font-bold">{t.reservations?.makeReservation || 'Rezervasyon Yap'}</h2>
          <button onClick={onClose} className="w-8 h-8 rounded-full bg-[#242424] flex items-center justify-center"><X className="w-5 h-5" /></button>
        </div>
        <div className="p-4 space-y-3">
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="text-gray-400 text-xs mb-1 block">{t.reservations?.date || 'Tarih'} *</label>
              <input type="date" value={date} onChange={(e) => setDate(e.target.value)} min={new Date().toISOString().split('T')[0]} className="w-full px-3 py-2.5 bg-[#242424] rounded-xl border border-white/5 outline-none text-sm" />
            </div>
            <div>
              <label className="text-gray-400 text-xs mb-1 block">{t.reservations?.time || 'Saat'} *</label>
              <select value={time} onChange={(e) => setTime(e.target.value)} className="w-full px-3 py-2.5 bg-[#242424] rounded-xl border border-white/5 outline-none text-sm">
                {['12:00', '13:00', '14:00', '18:00', '19:00', '20:00', '21:00'].map(t => <option key={t} value={t}>{t}</option>)}
              </select>
            </div>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="text-gray-400 text-xs mb-1 block">{t.reservations?.guests || 'Ki≈üi Sayƒ±sƒ±'} *</label>
              <select value={guests} onChange={(e) => setGuests(e.target.value)} className="w-full px-3 py-2.5 bg-[#242424] rounded-xl border border-white/5 outline-none text-sm">
                {[1,2,3,4,5,6,7,8].map(n => <option key={n} value={n}>{n} {t.reservations?.person || 'ki≈üi'}</option>)}
              </select>
            </div>
            <div>
              <label className="text-gray-400 text-xs mb-1 block">{t.reservations?.name || 'ƒ∞sim'} *</label>
              <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder={t.reservations?.yourName || 'Adƒ±nƒ±z'} className="w-full px-3 py-2.5 bg-[#242424] rounded-xl border border-white/5 outline-none text-sm" />
            </div>
          </div>
          <div>
            <label className="text-gray-400 text-xs mb-1 block">{t.reservations?.specialRequests || '√ñzel ƒ∞stekler'}</label>
            <textarea value={notes} onChange={(e) => setNotes(e.target.value)} placeholder={t.reservations?.specialRequestsPlaceholder || 'Varsa √∂zel isteklerinizi yazƒ±n'} rows={2} className="w-full px-3 py-2.5 bg-[#242424] rounded-xl border border-white/5 outline-none text-sm resize-none" />
          </div>
        </div>
        <div className="p-4 pt-0">
          <button onClick={handleSubmit} disabled={loading} className="w-full py-3.5 bg-orange-500 rounded-xl font-semibold flex items-center justify-center gap-2 disabled:opacity-50">
            {loading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" /> : t.reservations?.makeReservation || 'Rezervasyon Yap'}
          </button>
        </div>
      </div>
    </div>
  )
}

function WaiterCallModal({ venue, tableNumber, onClose }: { venue: Venue; tableNumber: string; onClose: () => void }) {
  const { t } = useI18n()
  const { profile } = useAuth()
  const [loading, setLoading] = useState(false)
  const [success, setSuccess] = useState(false)
  const [selectedType, setSelectedType] = useState<'waiter' | 'bill' | 'help'>('waiter')

  const callTypes = [
    { id: 'waiter' as const, icon: Coffee, label: t.venue?.callWaiter || 'Garson √áaƒüƒ±r', color: 'bg-blue-500' },
    { id: 'bill' as const, icon: CreditCard, label: t.venue?.requestBill || 'Hesap ƒ∞ste', color: 'bg-green-500' },
    { id: 'help' as const, icon: HelpCircle, label: t.venue?.needHelp || 'Yardƒ±m ƒ∞ste', color: 'bg-purple-500' },
  ]

  const handleCall = async () => {
    setLoading(true)
    try {
      await postApi('waiter_calls', {
        venue_id: venue.id,
        table_number: tableNumber,
        call_type: selectedType,
        anonymous_id: profile?.anonymous_id || 'GUEST',
        status: 'pending'
      })
      setSuccess(true)
    } catch (error) {
      console.error('Waiter call error:', error)
      alert(t.common?.error || 'Bir hata olu≈ütu')
    }
    setLoading(false)
  }

  if (success) {
    return (
      <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div className="w-full max-w-sm bg-[#1a1a1a] rounded-2xl p-6 text-center">
          <div className="w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto mb-4">
            <Bell className="w-8 h-8 text-green-500" />
          </div>
          <h2 className="text-xl font-bold mb-2">{t.common?.success || 'Ba≈üarƒ±lƒ±'}!</h2>
          <p className="text-gray-400 mb-4">{t.orders?.table || 'Masa'} {tableNumber}</p>
          <button onClick={onClose} className="w-full py-3 bg-orange-500 rounded-xl font-semibold">{t.common?.ok || 'Tamam'}</button>
        </div>
      </div>
    )
  }

  return (
    <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
      <div className="w-full max-w-sm bg-[#1a1a1a] rounded-2xl overflow-hidden">
        <div className="p-4 border-b border-white/10 flex items-center justify-between">
          <h2 className="text-xl font-bold">{t.venue?.callWaiter || 'Garson √áaƒüƒ±r'}</h2>
          <button onClick={onClose} className="w-8 h-8 rounded-full bg-[#242424] flex items-center justify-center"><X className="w-5 h-5" /></button>
        </div>
        <div className="p-4">
          <p className="text-gray-400 text-sm mb-4">{t.orders?.table || 'Masa'} {tableNumber}</p>
          <div className="space-y-2 mb-4">
            {callTypes.map(type => {
              const Icon = type.icon
              return (
                <button
                  key={type.id}
                  onClick={() => setSelectedType(type.id)}
                  className={`w-full p-4 rounded-xl flex items-center gap-4 transition-colors ${selectedType === type.id ? 'bg-orange-500/20 border-2 border-orange-500' : 'bg-[#242424] border-2 border-transparent'}`}
                >
                  <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${type.color}`}>
                    <Icon className="w-6 h-6 text-white" />
                  </div>
                  <span className="font-medium">{type.label}</span>
                </button>
              )
            })}
          </div>
          <button onClick={handleCall} disabled={loading} className="w-full py-3.5 bg-orange-500 rounded-xl font-semibold flex items-center justify-center gap-2 disabled:opacity-50">
            {loading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" /> : t.common?.send || 'G√∂nder'}
          </button>
        </div>
      </div>
    </div>
  )
}
